<include file="public@ptheader" />
<style type="text/css">
	/* 充值模态框内容样式 */
	.auth-code {width: 180px;display:none;height: 50px;margin: 5px 0 10px 0px;}
	.real-money {display:none;margin: 5px 0 10px 0px;width: 300px;}
	.card-list {width: 150px;}
	.recharge-type { margin-top: 24px; }
	.card-type { margin-top: 10px; overflow-y:auto;height: 320px;}
	.recharge-type .recharge-box {
		display: flex; flex-direction: row; align-items: center; flex-wrap: wrap;
	}
	.card-type .card-box {
		display: flex; flex-direction: row; align-items: center; flex-wrap: wrap;
	}
	.card-type .card-box > div {
		width: 200px;
		height:  260px;
		border-radius: 10px;
		background-color: rgba(240, 252, 251, 1);
		border: 1px solid #A6A2A2;
		margin-right: 14px;
		margin-bottom: 14px;
	}
	.card-type .card-box > div img { border-radius: 8px 8px 0 0;width:100%; height: auto;margin-top:5px;margin:0 auto;display: flex;align-items: center;}
	.card-type .card-box > div div span {margin-top: 3px;margin-bottom: 5px;line-height: 15px;display: inline-block;font-weight: 100;font-size: 14px;}
	.card-type .card-box > div div span span {margin-left: 5px;}

	.recharge-type .recharge-box > div {
		width: 116px;
		height:  50px;
		display: flex; flex-direction: row; justify-content: center; align-items: center;
		border: 1px solid #e9e9e9;
		margin-right: 14px;
		margin-bottom: 14px;
	}
	.recharge-type .recharge-box > div.active {
		border:3px solid rgba(26, 188, 156, 1);
	}
	.card-list {
		width: 200px
	}
	.card-type .card-box > div.active {
		border:3px solid rgba(26, 188, 156, 1);
	}
	.card-type .card-box > div:hover {
		border:3px solid rgba(26, 188, 156, 1);
	}
	.recharge-type .recharge-box > div:active,
	.recharge-type .recharge-box > div:hover,
	.recharge-type .recharge-box > div:visited,
	.recharge-type .recharge-box > div:hover {
		border-color: rgba(26, 188, 156, 1);
	}
	.recharge-type .recharge-box > div img { width:  26px; height:  26px; }
	.recharge-type .recharge-box > div span { font-size: 14px; color: #666; }

	.d1{
		height: 60px;
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding-left: 20px;
		padding-right: 20px;
	}
</style>
<div class="panel">
	<div class="d1">
		<span class="s1">用户昵称:&nbsp;&nbsp;{$data['nickname']}</span>
		<span class="s2">会员等级:&nbsp;&nbsp;{$data['level']}</span>
		<span class="s3">电话号码:&nbsp;&nbsp;{$data['mobile']}</span>
		<span class="s3">余额:&nbsp;&nbsp;{$data['money']}</span>
	</div>
	<div class="panel-head bg-main">购买服务卡</div>
	<div class="panel-body">
		<div class="panel">
			<div class="panel">
				<div class="panel-head bg-mix">
					选择服务卡
				</div>
				<div class="panel-body">
					<div class="card-type">
						<div class="card-box">
							<volist name ='card_list' id="v1">
								<div  data-card-id="{$v1.id}">
									<img src="{$v1.cover}" alt="">
									<div>
										<span><span>名称：</span>{$v1.name}</span> <br>
										<span><span>金额：</span>￥{$v1.money}</span><br>
										<span><span>项目：</span>{$v1.service_name}</span><br>
										<span style="{$v1.type == 1?'display: display;':'display: none;'}"><span>效期：</span>{$v1.expire_month} 个月</span>
									</div>
								</div>
							</volist>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- <div class="form-group real-money">
			<label class="text-red">改价后金额：</label><br>
			<label>
				<input type="text" class="input" id="real_money" placeholder="改价后金额，默认可不填写">
			</label>
			<label class="text-red">改价原因：</label><br>
			<label>
				<input type="text" class="input" id="edit_remark" placeholder="改价原因，必填">
			</label>
		</div> -->
		<div class="recharge-type">
			<p>选择充值方式</p>
			<div class="recharge-box">
				<div class="active" data-mode-id="5">
					<img src="__STATIC__/images/cashicon.png" alt="">
					<span>&nbsp;&nbsp;现金</span>
				</div>
				<div data-mode-id="4">
					<img src="__STATIC__/images/yhkicon.png" alt="">
					<span>&nbsp;&nbsp;银行卡</span>
				</div>
				<div data-mode-id="1">
					<img src="__STATIC__/images/wxicon.png" alt="">
					<span>&nbsp;&nbsp;微信</span>
				</div>
				<div data-mode-id="2">
					<img src="__STATIC__/images/zfbicon.png" alt="">
					<span>&nbsp;&nbsp;支付宝</span>
				</div>
				<div data-mode-id="3">
					<img src="__STATIC__/images/hykicon.png" alt="">
					<span>&nbsp;&nbsp;会员卡</span>
				</div>
				<div data-mode-id="7">
					<img src="__STATIC__/images/zengsong.png" alt="">
					<span>&nbsp;&nbsp;赠送</span>
				</div>
			</div>
		</div>
		<div class="form-group pay-money-tips">
			<div>
				<span style="color:red">请确认已收款</span>
			</div>
		</div>
		<div class="form-group auth-code">
			<label>付款码:</label>
			<label>
				<input type="text" class="input" id="auth-code" placeholder="请输入或者扫描付款码">
			</label>
		</div>
		<input type="hidden" class="input" id="id-auth-code" >
		<input type="hidden" class="input" id="order-sn" >
		<input type="hidden" class="input" id="uid" value="{$uid}">
		<button type="button" class="button bg-main text-center" id="recharge_save">确认购买</button>
	</div>
</div>
<script src="__STATIC__/js/admin.js"></script>
<script type="text/javascript">

	var host = "http://dd.ddxm661.com";
	var intervals = null;

	$(function(){
		let member_id = $('#uid').val();
		$.post("{:url('Member/buyCardIndex')}",{'id':member_id},function(re){
            if(re.code == 1){
				$('#id_auth_code').val( re.data.id_auth_code);
                $('#order-sn').val(re.data.order_sn);
            }
        })
	})

	$('.card-box > div').click(function(){
		$('.real-money').show();
		$(this).siblings("div.active").removeClass('active')
		$(this).addClass('active');
	});

	$('.recharge-box > div').click(function(){
		$(this).siblings("div.active").removeClass('active')
		$(this).addClass('active');
	});

	$('.recharge-box > div').click(function(){
		$pay_way = $(this).attr('data-mode-id');
		if ($pay_way == 1 || $pay_way == 2) {
			$('#auth-code').val('');
			$('.auth-code').show();
			$('#auth-code').focus();
			$('.pay-money-tips').hide();
		}else{
			$('#auth-code').val('');
			$('.pay-money-tips').show();
			$('.auth-code').hide();
		}
	});

	$('#real_money').change(function(){
		let real_money = $('#real_money').val();
		if(check_money(real_money) == false){
			layer.msg('输入金额不正确！',{icon:0});
			return false;
		}
		if(real_money > 0){
			$('#real_money').val('');
			layer.confirm('请确认本次改价！', {
	            btn : [ '确定', '取消' ]//按钮
	        }, function(index) {
				$('#real_money').val(real_money);
	            layer.close(index);
	        });
		}
	});

	//检验有效金额
	function check_money(money){
	    let money_match =/^(([1-9]\d*)|\d)(\.\d{1,2})?$/;
	    if(money_match.test(money) == false){
	        return false;
       	}else{
			return true;
		}
    }

	let orderPay = function () {
        console.log('开始支付');
        $('#recharge_save').hide();
        let url = host + "/wechat/api/userbuycard";
		let pay_way = $('div.recharge-box div.active').attr('data-mode-id');
        let service_card_id =  $('div.card-box div.active').attr('data-card-id');
        let member_id = $('#uid').val();
		let auth_code = $('#auth-code').val();
		let real_money = $('#real_money').val();
		let edit_remark = $('#edit_remark').val();
		let id_auth_code = $('#id_auth-code').val();
        let sn = $('#order-sn').val();//初始订单号
		if(real_money > 0 && edit_remark == ''){
			layer.msg('请输入改价原因',{icon:0});
            return;
		}
        if ((pay_way === 1 || pay_way === 2) && !auth_code) {
            layer.msg('请扫描付款码',{icon:0});
            return;
        }
        $.post( url,{
            order_sn:sn,
            member_id:member_id,
            service_card_id:service_card_id,
            pay_way:pay_way,
			auth_code:auth_code,
			edit_remark:edit_remark,
			real_money:real_money,
            id_auth_code:id_auth_code
        },function(data){
            if (data.code == 200) {
                layer.msg(data.msg,{icon:1});
                setTimeout(function () {
                    window.location.reload();
                }, 3500)

            }else if(data.code == 201){
                let order_sn = data.data.order_sn;
                let pay_type = $('div.recharge-box div.active').attr('data-mode-id');
                let urls = '';
                let close_urls = '';
                if (pay_type == 1) {
                    urls = host + "/wechat/api/queryWxOrder";
                    close_urls = host + "/wechat/api/closeWxOrder";
                }else if(pay_type == 2){
                    urls = host + "/wechat/api/queryAliOrder";
                    close_urls = host + "/wechat/api/closeAliOrder";
                }
                let times = 0;
                intervals = setInterval(function(){
                    times += 5;
                    $.post(urls,{order_sn:order_sn,sn:sn},function(res){
                        if (res.code == 200) {
                            layer.msg(res.msg,{icon:1});
                            setTimeout(function () {
                                window.location.reload();
                                clearInterval(intervals);
                                intervals = null;
                            }, 3500)
                            // var inte = setInterval(function(){
                            // 	window.location.reload();
                            // 	clearInterval(inte);
                            // }, 3500);
                        }else if (res.code === 300) {
                            layer.msg(res.msg,{icon:2});
                            setTimeout(function () {
                                window.location.reload();
                                clearInterval(intervals);
                                intervals = null;
                            }, 3500)
                        } else {
                            layer.msg(res.msg,{icon:0})
                        }
                        if(times === 60){
                            $.post(close_urls,{order_sn:order_sn,sn:sn},function(res){})
                            setTimeout(function () {
                                window.location.reload();
                                clearInterval(intervals);
                                intervals = null;
                            }, 3500)
                        }
                    });
                }, 5000);
            }else{
                layer.msg(data.msg,{icon:0});
				$('#recharge_save').show();
                setTimeout(function () {
                    window.location.reload();
                }, 3500)
            }
        })
    }

	$('#auth-code').bind('keypress', function (e) {
        if (e.keyCode == 13) {
            orderPay();
        }
    })

    $('#recharge_save').click(function(){
        // console.log($('div.recharge-box div.active').attr('data-mode-id'));return
        orderPay();
    })
</script>
<include file="public@ptfooter"/>
